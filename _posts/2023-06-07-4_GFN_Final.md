---
layout: post
title:  "Global Financial Network"
author: "Dasom Hong"
categories: journal
tag: [documentation]
image: spools.jpg
---

<head>
  <style>
    table.dataframe {
      white-space: normal;
      width: 100%;
      height: 240px;
      display: block;
      overflow: auto;
      font-family: Arial, sans-serif;
      font-size: 0.9rem;
      line-height: 20px;
      text-align: center;
      border: 0px !important;
    }

    table.dataframe th {
      text-align: center;
      font-weight: bold;
      padding: 8px;
    }

    table.dataframe td {
      text-align: center;
      padding: 8px;
    }

    table.dataframe tr:hover {
      background: #b8d1f3; 
    }

    .output_prompt {
      overflow: auto;
      font-size: 0.9rem;
      line-height: 1.45;
      border-radius: 0.3rem;
      -webkit-overflow-scrolling: touch;
      padding: 0.8rem;
      margin-top: 0;
      margin-bottom: 15px;
      font: 1rem Consolas, "Liberation Mono", Menlo, Courier, monospace;
      color: $code-text-color;
      border: solid 1px $border-color;
      border-radius: 0.3rem;
      word-break: normal;
      white-space: pre;
    }

  .dataframe tbody tr th:only-of-type {
      vertical-align: middle;
  }

  .dataframe tbody tr th {
      vertical-align: top;
  }

  .dataframe thead th {
      text-align: center !important;
      padding: 8px;
  }

  .page__content p {
      margin: 0 0 0px !important;
  }

  .page__content p > strong {
    font-size: 0.8rem !important;
  }

  </style>
</head>



```python
from bokeh.io import output_notebook, show, save, curdoc
from bokeh.models import Range1d, Circle, ColumnDataSource, MultiLine, EdgesAndLinkedNodes, NodesAndLinkedEdges, LabelSet
from bokeh.plotting import figure,output_notebook, show, output_file, save, figure
from bokeh.plotting import from_networkx
from bokeh.palettes import Spectral5, Spectral6, Spectral8, Spectral4
from bokeh.models import ColumnDataSource, CustomJS, Range1d, Select, StaticLayoutProvider, Oval, Circle 
from bokeh.models import HoverTool, TapTool, BoxSelectTool, GraphRenderer
from bokeh.models.widgets import RangeSlider, Button, DataTable, TableColumn, NumberFormatter, Panel, Tabs
from bokeh.io import curdoc, show, output_notebook
from bokeh.plotting import figure
from networkx.algorithms import community
from bokeh.models import EdgesAndLinkedNodes, NodesAndLinkedEdges
from bokeh.models.graphs import from_networkx, NodesAndLinkedEdges, EdgesAndLinkedNodes, NodesOnly
from bokeh.layouts import row, widgetbox, column
from bokeh.transform import linear_cmap
from networkx.algorithms import community
import pandas as pd
import networkx as nx
import matplotlib.pyplot as plt
import numpy as np
import pandas_bokeh
from ipywidgets import *
import plotly           
import plotly.express as px
```


```python
output_notebook() 
def modify_doc(doc):
    [code]
show(modify_doc, notebook_url="localhost:8888")
```


    <div class="bk-root">
        <a href="https://bokeh.org" target="_blank" class="bk-logo bk-logo-small bk-logo-notebook"></a>
        <span id="1002">Loading BokehJS ...</span>
    </div>



<script id="1003">
  (function() {
    const xhr = new XMLHttpRequest()
    xhr.responseType = 'blob';
    xhr.open('GET', "http://localhost:61525/autoload.js?bokeh-autoload-element=1003&bokeh-absolute-url=http://localhost:61525&resources=none", true);
    
    xhr.onload = function (event) {
      const script = document.createElement('script');
      const src = URL.createObjectURL(event.target.response);
      script.src = src;
      document.body.appendChild(script);
    };
    xhr.send();
  })();
</script>



```python
raw = pd.read_csv('./refined_data/GFN_Data.csv')
```


```python
raw['Year'] = raw['Year'].astype('int')
data = raw[raw['Year'] > 2010]
```


```python
data = data[['Country','Counterpart Country','Year','Assets','Liabilities','GROSS', 'NET', 'STOCK']]
```


```python
d = data[(data['Country']!='0')&(data['Counterpart Country']!='0')]
d.replace(0, np.nan, inplace=True)
```

<pre>
C:\Users\hdsab\AppData\Local\Temp\ipykernel_18100\2225311977.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  d.replace(0, np.nan, inplace=True)
</pre>

```python
year = sorted(d['Year'].unique().tolist())
origin = sorted(d['Country'].unique().tolist())
destination = sorted(d['Counterpart Country'].unique().tolist())
```


```python
d.describe()
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Year</th>
      <th>Assets</th>
      <th>Liabilities</th>
      <th>GROSS</th>
      <th>NET</th>
      <th>STOCK</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>338006.000000</td>
      <td>1.052890e+05</td>
      <td>1.245560e+05</td>
      <td>1.475910e+05</td>
      <td>1.475190e+05</td>
      <td>3.151860e+05</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2016.107359</td>
      <td>8.603187e+09</td>
      <td>3.237836e+09</td>
      <td>8.869869e+09</td>
      <td>3.406538e+09</td>
      <td>6.841523e+12</td>
    </tr>
    <tr>
      <th>std</th>
      <td>3.233222</td>
      <td>7.136094e+10</td>
      <td>3.011125e+10</td>
      <td>8.285138e+10</td>
      <td>4.433522e+10</td>
      <td>2.672872e+13</td>
    </tr>
    <tr>
      <th>min</th>
      <td>2011.000000</td>
      <td>-2.633675e+10</td>
      <td>-5.976866e+10</td>
      <td>-4.697310e+10</td>
      <td>-1.180328e+12</td>
      <td>-4.557647e+13</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2013.000000</td>
      <td>5.963484e+05</td>
      <td>4.020000e-01</td>
      <td>2.246796e+05</td>
      <td>-3.475502e+06</td>
      <td>-9.544382e+10</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>2016.000000</td>
      <td>2.500000e+07</td>
      <td>1.270169e+06</td>
      <td>1.822191e+07</td>
      <td>3.562300e+01</td>
      <td>-5.516196e+09</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2019.000000</td>
      <td>4.751044e+08</td>
      <td>8.991082e+07</td>
      <td>3.815243e+08</td>
      <td>5.371776e+07</td>
      <td>8.084446e+11</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2022.000000</td>
      <td>3.175643e+12</td>
      <td>1.945069e+12</td>
      <td>4.407409e+12</td>
      <td>3.059251e+12</td>
      <td>3.002650e+14</td>
    </tr>
  </tbody>
</table>
</div>



```python
def make_plot(df_source):
    G = nx.MultiDiGraph()
    d = df_source
    df = d[d['GROSS']>100000000000]
    #df = d[d['GROSS'] > (d['GROSS'].quantile(q=0.9))]
    a = df[['Country', 'Counterpart Country', 'Assets']].dropna()
    a['Value'] = 'assets'
    l = df[['Country', 'Counterpart Country', 'Liabilities']].dropna()
    l['Value'] = 'liabilities'
    a_pair = list(a[['Country', 'Counterpart Country', 'Value']].itertuples(index=False, name=None))
    assets = a['Assets'].values.tolist()
    l_pair = list(l[['Country', 'Counterpart Country', 'Value']].itertuples(index=False, name=None))
    liabilities = l['Liabilities'].values.tolist()
    
    a_value = dict(zip(a_pair, assets))
    a_val = {key:abs(value/500000000000) for key, value in a_value.items()}
    l_value = dict(zip(l_pair, liabilities))
    l_val = {key:abs(value/500000000000) for key, value in l_value.items()}
    
    G.add_edges_from(a_pair, relation = 'Assets')
    G.add_edges_from(a_pair, color = 'Blue')
    G.add_edges_from(l_pair, relation = 'Liabilities')
    G.add_edges_from(l_pair, color = 'Red')
    
    nx.set_edge_attributes(G, a_val, 'weight')
    nx.set_edge_attributes(G, l_val, 'weight')
    
    df['STOCK'] = abs(df['STOCK'].astype('float'))/5000000000000
    stock = dict(df[['Country','STOCK']].values.tolist())
    nx.set_node_attributes(G, stock, 'stock')
    
    color_palette = Spectral8
    communities = nx.algorithms.community.greedy_modularity_communities(G)
    
    modularity_class = {}
    modularity_color = {}
    
    for community_number, community in enumerate(communities):
        for name in community: 
            modularity_class[name] = community_number
            modularity_color[name] = Spectral8[community_number]
    
    nx.set_node_attributes(G, modularity_class, 'modularity_class')
    nx.set_node_attributes(G, modularity_color, 'modularity_color')
    
    node_color = 'modularity_color'
    node_size = 'stock'
    edge_color = 'color'
    edge_weight = 'weight'
    
    
    title = 'Global Financial Network'
    
    #Choose colors for node and edge highlighting
    node_highlight_color = 'white'
    edge_highlight_color = 'black'
    
    HOVER_TOOLTIPS = [
       ("Country", "@index"),
        ("Stock", "@stock"),
        ("Modularity Class", "@modularity_class"),
    ]
    
    #Create a plot — set dimensions, toolbar, and title
    plot = figure(tooltips = HOVER_TOOLTIPS,
                  tools="pan,wheel_zoom,save,reset, tap", 
                  active_scroll='wheel_zoom',
                  x_range=Range1d(-10.1, 10.1), y_range=Range1d(-10.1, 10.1), title=title)
    
    network_graph = from_networkx(G, nx.spring_layout, scale=10, center=(0, 0))
    network_graph.node_renderer.glyph = Circle(size=node_size, fill_alpha = 0.7, fill_color=node_color)
    network_graph.edge_renderer.glyph = MultiLine(line_alpha=0.3, line_width=edge_weight,line_color= edge_color)
    
    network_graph.node_renderer.hover_glyph = Circle(size=node_size, fill_color=node_highlight_color, line_width=2)
    network_graph.node_renderer.selection_glyph = Circle(size=node_size, fill_color=node_highlight_color, line_width=2)
    
    network_graph.edge_renderer.selection_glyph = MultiLine(line_color=edge_highlight_color, line_width=2)
    network_graph.edge_renderer.hover_glyph = MultiLine(line_color=edge_highlight_color, line_width=2)
    
    network_graph.selection_policy = NodesAndLinkedEdges()
    network_graph.inspection_policy = NodesAndLinkedEdges()

    plot.renderers.append(network_graph)
    
    x, y = zip(*network_graph.layout_provider.graph_layout.values())
    node_labels = list(G.nodes())
    source = ColumnDataSource({'x': x, 'y': y, 'name': [node_labels[i] for i in range(len(x))]})
    labels = LabelSet(x='x', y='y', text='name', source=source, background_fill_color='white', text_font_size='10px', background_fill_alpha=.7)
    plot.renderers.append(labels)
    
    return plot
```


```python
def plot(year):
    df = d
    #tot = df[(df['Year']==year)]
    tot = df[(df['Year']==year)]
    df_source=tot.dropna(subset=['GROSS'])
    #return df_source
    p = make_plot(df_source)
    show(p)
```


```python
interact(plot, year=year);
```

<pre>
interactive(children=(Dropdown(description='year', options=(2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 20…
</pre>
